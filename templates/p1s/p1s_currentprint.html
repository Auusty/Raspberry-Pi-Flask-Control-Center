<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Current Print</title>
    {% include "partials/head.html" %}
</head>

<body class="index-page page">

<!-- ================= Header ================= -->
<div class="header">
    <div class="header-left">
        <a href="{{ url_for('p1s.p1s') }}" class="header-btn back-btn">
            <img src="{{ url_for('static', filename='icons/back.svg') }}"
                 class="icon-img"
                 alt="Back">
        </a>

        <span id="header-time" class="header-time">--:--</span>
    </div>

    <h1 class="header-title">Current Print</h1>

    <div class="header-status" style="display:flex; align-items:center; gap:10px;">

        <!-- Surface button -->
        <button
            class="header-btn surface-btn"
            onclick="cycleSurface()"
            title="Change surface"
        >
            <img src="{{ url_for('static', filename='icons/layers.svg') }}"
                 class="icon-img"
                 alt="Surface">
        </button>

        <!-- Theme button -->
        <button
            class="header-btn theme-btn"
            onclick="cycleTheme()"
            title="Change theme"
        >
            <img src="{{ url_for('static', filename='icons/palette.svg') }}"
                 class="icon-img"
                 alt="Theme">
        </button>

        <!-- Printer status (unchanged) -->
        <span id="p1s-status-dot" class="status-dot unknown"></span>
        <span id="p1s-header-status">--</span>
    </div>
</div>

<!-- ================= Dashboard ================= -->
<div class="dashboard">
    <div class="tile-grid main-grid">

        <!-- Profile -->
        <div class="tile">
            <div class="label">Profile</div>
            <div class="label" id="printName">--</div>
        </div>

        <!-- Layers -->
        <div class="tile">
            <div class="label">Layer</div>
            <div class="label" id="layerInfo">-- / --</div>
        </div>

        <!-- Temps (combined) -->
        <div class="tile">
            <div class="label">Temperatures</div>
            <div class="label" id="nozzleTemp">Nozzle: -- / -- °C</div>
            <div class="label" id="bedTemp" style="opacity:.75;">Bed: -- / -- °C</div>
        </div>

        <!-- ETA -->
        <div class="tile">
            <div class="label">ETA</div>
            <div class="progress-bar">
                <div class="progress-fill" id="eta-progress"></div>
            </div>
            <div class="label" id="eta">--</div>
        </div>

    </div>
</div>

<!-- ================= Scripts ================= -->
<script>
function updateCurrentPrint() {

    /* ---------- LIVE STATUS ---------- */
    fetch("/api/p1s/status", { cache: "no-store" })
        .then(r => r.json())
        .then(s => {
            const state = s.state || "Unknown";
            const progress = Number(s.progress) || 0;

            // ETA
            document.getElementById("eta").textContent = s.eta || "--";
            document.getElementById("eta-progress").style.width = progress + "%";

            // Temps
            document.getElementById("nozzleTemp").textContent =
                `Nozzle: ${s.nozzle ?? "--"} / ${s.nozzle_target ?? "--"} °C`;

            document.getElementById("bedTemp").textContent =
                `Bed: ${s.bed ?? "--"} / ${s.bed_target ?? "--"} °C`;

            // Header text
            document.getElementById("p1s-header-status").textContent =
                state === "Printing"
                    ? `Printing · ${progress}%`
                    : state;

            // Header dot
            const dot = document.getElementById("p1s-status-dot");
            dot.className = "status-dot";

            if (state === "Printing") dot.classList.add("ingame");
            else if (state === "Preparing" || state === "Paused") dot.classList.add("away");
            else if (state === "Idle" || state === "Complete") dot.classList.add("online");
            else if (state === "Error" || state === "Offline") dot.classList.add("offline");
            else dot.classList.add("unknown");
        });

    /* ---------- FULL PRINT DATA ---------- */
    fetch("/api/p1s/full", { cache: "no-store" })
        .then(r => r.json())
        .then(f => {
            const p = f.print || {};

            document.getElementById("printName").textContent =
                p.subtask_name || "--";

            const layer = Number.isFinite(p.layer_num)
                ? Math.min(p.layer_num + 1, p.total_layer_num)
                : "--";

            const total = Number.isFinite(p.total_layer_num)
                ? p.total_layer_num
                : "--";

            document.getElementById("layerInfo").textContent =
                `${layer} / ${total}`;
        });
}

updateCurrentPrint();
setInterval(updateCurrentPrint, 3000);
</script>

<script src="{{ url_for('static', filename='js/header_time.js') }}"></script>
<script src="{{ url_for('static', filename='js/theme.js') }}"></script>

</body>
</html>
